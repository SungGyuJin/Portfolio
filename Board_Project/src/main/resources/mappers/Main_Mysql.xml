<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gyu.portfolio.service.mapper.MainMapper">
	
	<resultMap id="mainVO" type="mainVO">
		<result property="mainSeq"		column="MAIN_SEQ"		/>
		<result property="mainSe"		column="MAIN_SE" 		/>
		<result property="topBnNm"		column="TOP_BN_NM" 		/>
		<result property="botmBnNm"		column="BOTM_BN_NM" 	/>
		<result property="techNm"		column="TECH_NM" 		/>
		<result property="poforNm"		column="POFOR_NM" 		/>
		<result property="srtOrd"		column="SRT_ORD" 	  	/>
		
		<result property="boardSeq"		column="BOARD_SEQ"		/>
		<result property="fileNm"		column="FILE_NM" 	  	/>
		<result property="fileExt"		column="FILE_EXT" 	  	/>
		<result property="fileSz"		column="FILE_SZ" 	  	/>
		<result property="filePath"		column="FILE_PATH" 	  	/>
		<result property="strgFileNm"	column="STRG_FILE_NM" 	/>
		<result property="thumbYn"		column="THUMB_YN" 	  	/>
		
		<result property="regNo"		column="REG_NO" 		/>
		<result property="regDt"		column="REG_DT" 		/>
		<result property="updNo"		column="UPD_NO" 		/>
		<result property="updDt"		column="UPD_DT" 		/>
		<result property="stat"			column="STAT" 			/>
		
		<result property="taRegDt"		column="TA_REG_DT" 		/>
		<result property="taUpdDt"		column="TA_UPD_DT" 		/>
		
	</resultMap>
	
	<insert id="addMain">
		INSERT INTO TB_MAIN(
			MAIN_SE
			, TOP_BN_NM
			, BOTM_BN_NM
			, TECH_NM
			, POFOR_NM
			, SRT_ORD
			, REG_NO
			, REG_DT
			, UPD_NO
			, UPD_DT
			, STAT
		)VALUES (
			#{mainSe}
			, #{topBnNm}
			, #{botmBnNm}
			, #{techNm}
			, #{poforNm}
			<choose>
				<when test='mainSe.equals("T")'>, (SELECT MAX(SRT_ORD)+1 FROM (SELECT SRT_ORD FROM TB_MAIN WHERE MAIN_SE = 'T') AS TMP)</when>
				<otherwise>, 0</otherwise>
			</choose>
			, #{regNo}
			, NOW()
			, #{regNo}
			, NOW()
			, 1
		)
		<selectKey keyProperty="mainSeq" resultType="integer" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<update id="updateMain">
		UPDATE
			TB_MAIN A JOIN TB_MAIN B ON A.MAIN_SEQ = B.MAIN_SEQ
		SET
		    A.TOP_BN_NM  = #{topBnNm}
		    , A.BOTM_BN_NM = #{botmBnNm}
		    , A.TECH_NM    = #{techNm}
		    , A.POFOR_NM   = #{poforNm}
		    , A.UPD_NO     = #{updNo}
		    , A.UPD_DT	   =
			<choose>
				<when test='mainSe.equals("B")'>CASE WHEN B.TOP_BN_NM != #{topBnNm} OR B.BOTM_BN_NM != #{botmBnNm} THEN NOW() ELSE A.UPD_DT END</when>
				<when test='mainSe.equals("P")'>CASE WHEN B.POFOR_NM = #{poforNm} THEN A.UPD_DT ELSE NOW() END</when>
				<otherwise>CASE WHEN B.TECH_NM = #{techNm} THEN A.UPD_DT ELSE NOW() END</otherwise>
			</choose>
		WHERE A.MAIN_SEQ = #{mainSeq}
	</update>
	
	<select id="getMainList" resultMap="mainVO">
		SELECT
			MAIN_SEQ
			, MAIN_SE
			, TOP_BN_NM
			, BOTM_BN_NM
			, TECH_NM
			, POFOR_NM
			, SRT_ORD
			, REG_NO
			, REG_DT
			, UPD_NO
			, UPD_DT
			, STAT
		FROM TB_MAIN
		WHERE 1=1
			AND MAIN_SEQ = #{mainSeq}
			AND MAIN_SE = #{mainSe}
	</select>
	
	<select id="getMain" resultMap="mainVO">
		SELECT
			TM.MAIN_SEQ
			, TM.MAIN_SE
			, TM.TOP_BN_NM
			, TM.BOTM_BN_NM
			, TM.TECH_NM
			, TM.POFOR_NM
			, TM.SRT_ORD
			, TM.REG_NO
			, TM.REG_DT
			, TM.UPD_NO
			, TM.UPD_DT
			, TM.STAT
			, TA.BOARD_SEQ
			, TA.FILE_NM
			, TA.FILE_EXT
			, TA.FILE_SZ
			, TA.FILE_PATH
			, TA.STRG_FILE_NM
			, TA.THUMB_YN
			, TA.REG_DT AS TA_REG_DT
			, TA.UPD_DT AS TA_UPD_DT
		FROM TB_MAIN TM LEFT JOIN TB_ATTACH TA ON TM.MAIN_SEQ = TA.BOARD_SEQ 
		WHERE 1=1
			AND TM.MAIN_SE = #{mainSe}
			AND TM.STAT NOT IN('9')
		ORDER BY SRT_ORD ASC
	</select>
	
	<update id="updateStat">
		UPDATE
			TB_MAIN
		SET
			UPD_NO 		= #{updNo}
			, UPD_DT 	= NOW()
			, STAT 		= #{stat}
		WHERE 1=1
			AND MAIN_SEQ = #{mainSeq}
	</update>
	
	<delete id="deleteMain">
		DELETE FROM TB_MAIN
		WHERE 1=1
			AND MAIN_SEQ IN(
		 	<foreach collection="delSeqArr" item="seq" separator=",">
		 		#{seq}
		 	</foreach>
			)
	</delete>
	
	<update id="updateMainSrtOrd">
		UPDATE TB_MAIN SET SRT_ORD = #{srtOrd} WHERE MAIN_SEQ = #{mainSeq}
	</update>
	
</mapper>