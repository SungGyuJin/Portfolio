<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.board.service.mapper.BoardMapper">
	
	<resultMap id="boardVO" type="boardVO">
		<result property="boardSeq"		column="BOARD_SEQ" 	/>
		<result property="bbsSeq"		column="BBS_SEQ" 	/>
		<result property="title"		column="TITLE" 		/>
		<result property="cont"			column="CONT" 		/>
		<result property="ref"			column="REF" 		/>
		<result property="step"			column="STEP" 		/>
		<result property="lvl"			column="LVL" 		/>
		<result property="pwd"			column="PWD" 		/>
		<result property="readCnt"		column="READ_CNT" 	/>
		
		<result property="regNo"		column="REG_NO" 	/>
		<result property="regDt"		column="REG_DT" 	/>
		<result property="updNo"		column="UPD_NO" 	/>
		<result property="updDt"		column="UPD_DT" 	/>
		<result property="stat"			column="STAT" 		/>
		
		<!-- 그 외 필드 -->
		<result property="replyYn"		column="REPLY_YN" 	/>
		<result property="atchYn"		column="ATCH_YN" 	/>
		<result property="secrtYn"		column="SECRT_YN" 	/>
		<result property="bbsStat"		column="BBS_STAT" 	/>
		<result property="bbsNm"		column="BBS_NM" 	/>
		<result property="userNm"		column="USER_NM" 	/>
	</resultMap>
	
	<!-- 게시물 총 개수 -->
    <select id="getBoardListCnt" resultType="int">
        SELECT
        	COUNT(*)
        FROM TB_BOARD T1
		WHERE 1=1
			<if test="bbsSeq > 0">
				AND BBS_SEQ = #{bbsSeq}
			</if>
			<if test="listTyp.equals('list')">
				AND STAT = 1
			</if>
			<if test="listTyp.equals('trash')">
				AND STAT = 0
			</if>
				<if test="searchKeyword != null and !searchKeyword.equals('')">
					<choose>
						<when test="gubun.equals('ttl')">AND TITLE LIKE CONCAT('%', #{searchKeyword}, '%')</when>
						<when test="gubun.equals('cn')">AND CONT LIKE CONCAT('%', #{searchKeyword}, '%')</when>
						<when test="gubun.equals('writer')">AND (SELECT USER_NM FROM TB_USER WHERE USER_SEQ = T1.REG_NO) LIKE CONCAT('%', #{searchKeyword}, '%')</when>
						<otherwise>
							AND TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
							OR CONT LIKE CONCAT('%', #{searchKeyword}, '%')
							OR (SELECT USER_NM FROM TB_USER WHERE USER_SEQ = T1.REG_NO) LIKE CONCAT('%', #{searchKeyword}, '%')
						</otherwise>
					</choose>
				</if>
    </select>
	
	<!-- 게시물 목록 -->
	<select id="getBoardList" resultMap="boardVO">
		SELECT * FROM (
			SELECT
				BOARD_SEQ
				, BBS_SEQ
				, TITLE
				, CONT
				, REF
				, STEP
				, LVL
				, PWD
				, READ_CNT
				, REG_NO
				, REG_DT
				, UPD_NO
				, UPD_DT
				, STAT
				, (SELECT NM FROM TB_BBS WHERE BBS_SEQ = T1.BBS_SEQ) BBS_NM
				, (SELECT USER_NM FROM TB_USER WHERE USER_SEQ = T1.REG_NO) USER_NM
			FROM TB_BOARD T1
			WHERE 1=1
				<if test="bbsSeq > 0">
					AND BBS_SEQ = #{bbsSeq}
				</if>
				<if test="listTyp.equals('list')">
					AND STAT = 1
				</if>
				<if test="listTyp.equals('trash')">
					AND STAT = 0
				</if>
				<if test="searchKeyword != null and !searchKeyword.equals('')">
					<choose>
						<when test="gubun.equals('ttl')">AND TITLE LIKE CONCAT('%', #{searchKeyword}, '%')</when>
						<when test="gubun.equals('cn')">AND CONT LIKE CONCAT('%', #{searchKeyword}, '%')</when>
						<when test="gubun.equals('writer')">AND (SELECT USER_NM FROM TB_USER WHERE USER_SEQ = T1.REG_NO) LIKE CONCAT('%', #{searchKeyword}, '%')</when>
						<otherwise>
							AND TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
							OR CONT LIKE CONCAT('%', #{searchKeyword}, '%')
							OR (SELECT USER_NM FROM TB_USER WHERE USER_SEQ = T1.REG_NO) LIKE CONCAT('%', #{searchKeyword}, '%')
						</otherwise>
					</choose>
				</if>
		) AS T1
		ORDER BY REF DESC, STEP
		LIMIT #{skip}, #{amount}
	</select>
	
	<!-- 게시물 상세조회 -->
	<select id="getBoard" resultMap="boardVO">
		SELECT
			B.BOARD_SEQ
			, B.BBS_SEQ
			, B.TITLE
			, B.CONT
			, B.REF
			, B.STEP
			, B.LVL
			, B.PWD
			, B.READ_CNT
			, B.REG_NO
			, B.REG_DT
			, B.UPD_NO
			, B.UPD_DT
			, B.STAT
			, BBS.NM AS BBS_NM
			, BBS.REPLY_YN
			, BBS.ATCH_YN
			, BBS.SECRT_YN
			, BBS.STAT AS BBS_STAT
		FROM TB_BOARD B LEFT JOIN TB_BBS BBS ON B.BBS_SEQ = BBS.BBS_SEQ
		WHERE 1=1
			AND BOARD_SEQ = #{boardSeq}
	</select>
	
	<!-- 게시물 등록 -->
	<insert id="addBoard">
		INSERT INTO TB_BOARD(
			BBS_SEQ
			, TITLE
			, CONT
			, REF
			, STEP
			, LVL
			, PWD
			, READ_CNT
			, REG_NO
			, REG_DT
			, UPD_NO
			, UPD_DT
			, STAT
		)VALUES (
			#{bbsSeq}
			, #{title}
			, #{cont}
			, #{ref}
			, #{step}
			, #{lvl}
			, #{pwd}
			, #{readCnt}
			, #{regNo}
			, NOW()
			, #{regNo}
			, NOW()
			, 1
		)
		<selectKey keyProperty="boardSeq" resultType="integer" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>		
	</insert>
	
	<update id="updateRef">
		<choose>
			<when test="ref > 0">UPDATE TB_BOARD SET REF = #{ref} WHERE BOARD_SEQ = #{boardSeq}</when>
			<otherwise>UPDATE TB_BOARD SET REF = #{boardSeq} WHERE BOARD_SEQ = #{boardSeq}</otherwise>
		</choose>
	</update>
	
	<update id="updateStep">
		UPDATE
			TB_BOARD
		SET
			STEP = STEP + 1
		WHERE 1=1 
<!-- 			AND REF = #{ref} AND STEP > #{step} -->
			AND REF = #{ref} AND STEP >= #{step}
	</update>
	
	
	<update id="updateOldStep">
		UPDATE
			TB_BOARD
		SET
			STEP = STEP + 1
		WHERE 1=1 
			AND REF = #{ref} AND STEP = #{step}
	</update>
	
	<select id="getMaxStep" resultType="int">
		SELECT
			MAX(STEP) + 1
		FROM TB_BOARD
		WHERE 1=1
			AND REF = #{ref}
	</select>
	
	<update id="updateLvl">
		UPDATE 
			TB_BOARD
		SET
			LVL = #{lvl} + 1
		WHERE 1=1
			AND BOARD_SEQ = #{boardSeq}
	</update>
	
	<!-- 게시물 수정 -->
	<update id="updateBoard">
		UPDATE
			TB_BOARD
		SET
			TITLE    = #{title}
			, CONT 	 = #{cont}
			, UPD_NO = #{updNo}
			, UPD_DT = NOW()
		WHERE 1=1
			AND BOARD_SEQ = #{boardSeq}
	</update>
	
	<!-- 게시물 상태변경(복구, 삭제, 영구삭제)(Ajax) -->
	<update id="changeStat">
		UPDATE
			TB_BOARD
		SET
			STAT = #{stat}
			, UPD_NO = #{updNo}
			, UPD_DT = NOW()
		WHERE 1=1
			AND BOARD_SEQ = #{boardSeq}
	</update>


</mapper>