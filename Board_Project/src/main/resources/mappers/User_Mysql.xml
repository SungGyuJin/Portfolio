<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gyu.portfolio.service.mapper.UserMapper">
	
	<resultMap id="userVO" type="userVO">
		<result property="userSeq"	column="USER_SEQ"	/>
		<result property="userId"	column="USER_ID" 	/>
		<result property="userPwd"	column="USER_PWD" 	/>
		<result property="userNm"	column="USER_NM" 	/>
		<result property="userSe"	column="USER_SE" 	/>
		
		<result property="fileNm"		column="FILE_NM" 	  />
		<result property="fileExt"		column="FILE_EXT" 	  />
		<result property="fileSz"		column="FILE_SZ" 	  />
		<result property="filePath"		column="FILE_PATH" 	  />
		<result property="strgFileNm"	column="STRG_FILE_NM" />
		<result property="rsMatch"	    column="RS_MATCH"	/>
		
		<result property="stat"		column="STAT" 		/>
		<result property="inputPwd"	column="INPUT_PWD" 	/>
	</resultMap>
	
	<!-- 사용자 목록 -->
	<select id="getUserList" resultMap="userVO">
		SELECT
			USER_SEQ
			, USER_ID
			, USER_PWD
			, USER_NM
			, USER_SE
			, STAT
		FROM TB_USER
		WHERE 1=1
			AND USER_SE = 'U'
			<if test="listTyp.equals('list')">
				AND STAT > 0
			</if>
			<if test="listTyp.equals('leave')">
				AND STAT = 0
			</if>
			<if test="searchKeyword != null and !searchKeyword.equals('')">
				AND USER_NM LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
		ORDER BY USER_SEQ DESC
	</select>
	
	<!-- 사용자 목록 수 -->
	<select id="getUserListCnt" resultType="int">
		SELECT
			COUNT(*)
		FROM TB_USER
		WHERE 1=1
			AND USER_SE = 'U'
			<if test="listTyp.equals('list')">
				AND STAT > 0
			</if>
			<if test="listTyp.equals('leave')">
				AND STAT = 0
			</if>
			<if test="searchKeyword != null and !searchKeyword.equals('')">
				AND USER_NM LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
	</select>
	
	<!-- 사용자 상세조회 -->
	<select id="getUser" resultMap="userVO">
		SELECT
			USER_SEQ
			, USER_ID
			, USER_PWD
			, SHA2(#{userPwd}, 256) INPUT_PWD
			, USER_NM
			, USER_SE
			, STAT
		FROM TB_USER
		WHERE 1=1
			AND USER_ID = #{userId}
	</select>
	
	<!-- 사용자 상세조회 -->
	<select id="getUserInfo" resultMap="userVO">
		SELECT
			USER_SEQ
			, USER_ID
			, USER_NM
			, USER_SE
			, STAT
			, (SELECT FILE_PATH FROM TB_ATTACH WHERE BOARD_SEQ = 0 AND STAT = 1 AND REG_NO = T1.USER_SEQ) FILE_PATH
			, (SELECT STRG_FILE_NM FROM TB_ATTACH WHERE BOARD_SEQ = 0 AND  STAT = 1 AND REG_NO = T1.USER_SEQ) STRG_FILE_NM
		FROM TB_USER T1
		WHERE 1=1
			AND USER_SEQ = #{userSeq}
	</select>
	
	<!-- 사용자 등록 -->
	<insert id="addUser">
		INSERT INTO TB_USER(
			USER_ID
			, USER_PWD
			, USER_NM
			, USER_SE
			, STAT
		)VALUES (
			#{userId}
			, SHA2(#{userPwd}, 256)
			, #{userNm}
			, #{userSe}
			, 1
		)
	</insert>
	
	<!-- 사용자 수정(사용자 화면) -->
	<update id="updateUser">
		UPDATE
			TB_USER
		SET
			USER_NM	= #{userNm}
		<if test="userPwd != null and userPwd != ''">
			, USER_PWD	= SHA2(#{userPwd}, 256)
		</if>
		WHERE 1=1
			AND USER_SEQ = #{userSeq}
	</update>
	
	
	<!-- 사용자 권한정보 수정(관리자 화면) -->
	<update id="updateUserAdmin">
		UPDATE
			TB_USER
		SET
			STAT = #{stat}
		WHERE 1=1
			AND USER_SEQ = #{userSeq}
			AND USER_ID = #{userId}
	</update>
	
	<select id="chkPwdUser" resultMap="userVO">
		SELECT
			CASE
				WHEN USER_PWD = SHA2(#{pwd}, 256)
				THEN 'S'
				ELSE 'F'
			END RS_MATCH		
		FROM TB_USER
		WHERE 1=1
			AND USER_SEQ = #{userSeq}
	</select>
	
</mapper>